# Компонент Style Downloader

## Обзор

Класс `StyleDownloader` обрабатывает загрузку и обработку стилей Mapbox из удаленных источников. Он управляет полным жизненным циклом приобретения стилей, включая аутентификацию, извлечение ресурсов и организацию активов для нескольких источников стилей.

## Основной функционал

### Процесс загрузки

Процесс загрузки стилей следует комплексному рабочему процессу:

1. **Подготовка директорий**: Создает необходимую структуру директорий для организованного хранения
2. **Загрузка стилей**: Загружает JSON файлы стилей из удаленных URL с поддержкой аутентификации
3. **Извлечение ресурсов**: Извлекает ссылки на спрайты и шрифты из JSON стилей
4. **Загрузка активов**: Загружает спрайты и глифы шрифтов из удаленных источников
5. **Организация файлов**: Организует загруженные активы по стилям с правильными соглашениями об именовании

### Ключевые методы

#### `download_all`
Загружает все настроенные стили в системе, перебирая конфигурацию и обрабатывая каждый смешанный стиль.

#### `download_style(mix_id)`
Загружает конкретную конфигурацию стиля, идентифицированную по mix_id, включая все его исходные стили и связанные ресурсы.

#### `process_mix_style(mix_id, mix_config)`
Обрабатывает полную конфигурацию смешанного стиля:
- Загружает все исходные стили для смешивания
- Извлекает ссылки на спрайты и шрифты из каждого стиля
- Загружает все необходимые активы (спрайты, шрифты)
- Организует файлы с правильным именованием и структурой

### Загрузка стилей

Загружает JSON файлы стилей с комплексной поддержкой аутентификации:

```ruby
def download_source_style(source_config, mix_id, index)
  source_url = source_config.is_a?(Hash) ? source_config['url'] : source_config
  auth_config = source_config.is_a?(Hash) ? source_config['auth'] : nil
  
  headers = {}
  if auth_config
    credentials = Base64.strict_encode64("#{auth_config['username']}:#{auth_config['password']}")
    headers['Authorization'] = "Basic #{credentials}"
  end
  
  resp = Faraday.get(source_url, headers: headers)
  raise "Failed to fetch #{source_url}" unless resp.success?
  
  style_json = JSON.parse(resp.body)
  # Обработка и сохранение стиля...
end
```

**Особенности загрузки**:
- **Поддержка URL**: Обрабатывает как простые URL, так и сложные конфигурации
- **Аутентификация**: Поддержка Basic Auth для защищенных источников стилей
- **Обработка ошибок**: Комплексная проверка и отчетность об ошибках
- **Валидация JSON**: Обеспечивает, что загруженный контент является валидным JSON

### Извлечение ресурсов

#### Извлечение спрайтов
Извлекает URL спрайтов из JSON стилей и загружает как обычные, так и @2x версии:

**Процесс извлечения**:
- **Обнаружение URL**: Определяет URL спрайтов в JSON стилей
- **Поддержка версий**: Обрабатывает как обычные, так и @2x варианты спрайтов
- **Загрузка метаданных**: Загружает как PNG изображения, так и JSON метаданные
- **Организация файлов**: Организует спрайты по стилям и разрешениям

#### Извлечение шрифтов
Извлекает ссылки на стеки шрифтов и загружает диапазоны глифов:

**Обработка шрифтов**:
- **Обнаружение стеков шрифтов**: Определяет стеки шрифтов в конфигурации стилей
- **Расчет диапазонов глифов**: Определяет необходимые диапазоны глифов
- **Загрузка диапазонов**: Загружает файлы глифов для каждого диапазона (0-255, 256-511, и т.д.)
- **Организация шрифтов**: Организует шрифты по имени стека шрифтов

### Организация файлов

Организует загруженные файлы с иерархической структурой:

```
raw_styles/
  mix_style1_source1_1.json
  mix_style1_source2_2.json

sprites/
  mix_style1_source1_1/
    sprite.png
    sprite.json
  mix_style1_source1_1_@2x/
    sprite.png
    sprite.json

fonts/
  fontstack_name/
    0-255.pbf
    256-511.pbf
    512-767.pbf
    ...
```

**Стратегия организации**:
- **Разделение стилей**: Каждый исходный стиль получает свою собственную директорию
- **Категоризация ресурсов**: Спрайты и шрифты в отдельных директориях
- **Соглашение об именовании**: Использует mix_id и индекс источника для уникальной идентификации
- **Поддержка разрешений**: Отдельные директории для обычных и @2x спрайтов

### Поддержка аутентификации

Поддерживает Basic Authentication для защищенных источников стилей с гибкой конфигурацией:

```yaml
styles:
  mix_style1:
    sources:
      - url: "https://example.com/style.json"
        auth:
          username: "user"
          password: "pass"
        prefix: "custom_prefix"
```

**Особенности аутентификации**:
- **Basic Auth**: Стандартная аутентификация по имени пользователя/паролю
- **Гибкая конфигурация**: Поддерживает как простые URL, так и сложные конфигурации
- **Безопасная обработка**: Правильное кодирование и передача учетных данных
- **Восстановление ошибок**: Graceful обработка сбоев аутентификации

### Параллельная обработка

Использует параллельную обработку для эффективной загрузки нескольких ресурсов:

```ruby
def download_fonts(fontstacks, glyphs_urls)
  Parallel.each(fontstacks, in_threads: 4) do |fontstack|
    download_font_glyphs(fontstack, glyphs_urls)
  end
end
```

**Преимущества параллельной обработки**:
- **Параллельные загрузки**: Несколько ресурсов загружаются одновременно
- **Управление потоками**: Настраиваемое количество потоков для оптимальной производительности
- **Эффективность ресурсов**: Значительно сокращает общее время загрузки
- **Изоляция ошибок**: Отдельные сбои загрузки не влияют на другие

### Обработка ошибок

Комплексная обработка ошибок для различных сетевых и файловых системных сценариев:

**Обработка сетевых ошибок**:
- **Сбои соединения**: Повторные попытки с экспоненциальной задержкой
- **Обработка таймаутов**: Настраиваемые значения таймаута
- **HTTP коды ошибок**: Правильная обработка 4xx и 5xx ответов
- **Разрешение DNS**: Обрабатывает сбои разрешения доменов

**Обработка ошибок файловой системы**:
- **Проблемы с правами**: Проверяет и обрабатывает ошибки прав доступа к файлам
- **Дисковое пространство**: Проверяет доступное дисковое пространство перед загрузками
- **Создание директорий**: Обрабатывает сбои создания директорий
- **Повреждение файлов**: Проверяет целостность загруженных файлов

**Обработка ошибок аутентификации**:
- **Неверные учетные данные**: Обрабатывает сбои аутентификации
- **Истекшие токены**: Управляет сценариями истечения токенов
- **Доступ запрещен**: Обрабатывает сбои авторизации

**Graceful Degradation**:
- **Частичные загрузки**: Продолжает обработку, когда некоторые ресурсы не удаются
- **Логирование ошибок**: Комплексное логирование для отладки
- **Механизмы отката**: Альтернативные подходы, когда основные методы не удаются

### Интеграция

Бесшовно интегрируется с другими компонентами системы:

**Интеграция с конфигурацией**:
- **YAML конфигурация**: Читает из `styles_config.yaml`
- **Определения стилей**: Обрабатывает конфигурации смешивания стилей
- **Управление источниками**: Обрабатывает несколько исходных стилей на смешивание
- **Поддержка префиксов**: Поддерживает пользовательские префиксы для идентификации стилей

**Интеграция с StyleMixer**:
- **Подготовка файлов**: Подготавливает необработанные файлы стилей для смешивания
- **Доступность ресурсов**: Обеспечивает доступность всех необходимых ресурсов
- **Сохранение метаданных**: Сохраняет метаданные стилей для процесса смешивания
- **Распространение ошибок**: Отчитывается о статусе загрузки в процесс смешивания

**Интеграция с SpriteMerger**:
- **Организация спрайтов**: Предоставляет организованные файлы спрайтов для объединения
- **Файлы метаданных**: Поставляет JSON метаданные спрайтов для обработки координат
- **Поддержка разрешений**: Предоставляет как обычные, так и @2x варианты спрайтов
- **Структура файлов**: Поддерживает согласованную организацию файлов

**Системная интеграция**:
- **Структура директорий**: Создает и поддерживает необходимые директории
- **Именование файлов**: Использует согласованные соглашения об именовании между компонентами
- **Управление ресурсами**: Управляет дисковым пространством и организацией файлов
- **Отслеживание прогресса**: Предоставляет информацию о прогрессе загрузки
