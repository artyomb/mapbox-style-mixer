# Компонент Style Mixer

## Обзор

Класс `StyleMixer` отвечает за объединение нескольких стилей Mapbox в единую конфигурацию смешанного стиля. Он обрабатывает сложный процесс объединения источников, слоев и метаданных, обеспечивая правильное управление префиксами для избежания конфликтов именования между различными источниками стилей.

## Основной функционал

### Процесс смешивания стилей

Процесс смешивания стилей включает несколько сложных этапов:

1. **Создание базовой структуры**: Создает начальную структуру стиля с правильной версией Mapbox и метаданными
2. **Загрузка источников**: Загружает необработанные файлы стилей с диска с валидацией и обработкой ошибок
3. **Генерация префиксов**: Генерирует уникальные префиксы для каждого исходного стиля для предотвращения конфликтов
4. **Объединение ресурсов**: Объединяет источники, слои и метаданные с правильными преобразованиями
5. **Интеграция спрайтов**: Интегрирует объединенные спрайт-активы с правильными URL ссылками
6. **Генерация выходных данных**: Сохраняет финальный смешанный стиль в JSON с правильным форматированием

### Ключевые методы

#### `mix_all_styles`
Обрабатывает все настроенные стили в системе, перебирая конфигурацию и вызывая отдельные операции смешивания.

#### `mix_styles(mix_id, mix_config)`
Смешивает конкретную конфигурацию стиля:
- Создает базовую структуру с правильной версией Mapbox
- Загружает и валидирует все исходные стили
- Генерирует уникальные префиксы для избежания конфликтов
- Объединяет все ресурсы (источники, слои, метаданные)
- Интегрирует спрайт-активы с правильными ссылками
- Сохраняет финальный смешанный стиль в выходную директорию

### Генерация префиксов

Генерирует уникальные префиксы для каждого исходного стиля для избежания конфликтов именования:

```ruby
def generate_prefixes(source_styles)
  used_prefixes = Set.new
  
  source_styles.map.with_index do |style, index|
    base_prefix = style['_config_prefix'] || style['id'] || 
                  style['name']&.downcase&.gsub(/\s+/, '_') || "style_#{index + 1}"
    clean_prefix = base_prefix.gsub(/[^a-zA-Z0-9_]/, '_').squeeze('_')
    prefix = resolve_conflicts(clean_prefix, used_prefixes)
    used_prefixes.add(prefix)
    prefix
  end
end
```

**Стратегия генерации префиксов**:
- **Приоритет источника**: Использует `_config_prefix` если доступен, затем `id`, затем `name`
- **Резервное именование**: Генерирует `style_#{index + 1}` если нет доступного идентификатора
- **Разрешение конфликтов**: Обеспечивает уникальные префиксы для всех исходных стилей
- **Очистка символов**: Удаляет недопустимые символы и нормализует именование

### Объединение ресурсов

#### Объединение источников
Объединяет источники тайлов из нескольких стилей с префиксными именами:

**Процесс объединения**:
- **Сбор источников**: Собирает все источники тайлов из исходных стилей
- **Применение префиксов**: Применяет уникальные префиксы к именам источников
- **Сохранение URL**: Сохраняет исходные URL тайлов и параметры
- **Обработка типов**: Сохраняет типы источников (vector, raster, geojson, и т.д.)

**Пример преобразования**:
```json
// Исходный источник
{
  "source1": {
    "type": "vector",
    "url": "https://example.com/tiles"
  }
}

// После префиксирования
{
  "weather_source1": {
    "type": "vector", 
    "url": "https://example.com/tiles"
  }
}
```

#### Объединение слоев
Объединяет определения слоев с обновленными ссылками на источники и метаданными:

**Обработка слоев**:
- **Обновление ссылок на источники**: Обновляет ссылки слоев на источники к префиксным именам
- **Сохранение метаданных**: Сохраняет метаданные и свойства слоев
- **Сохранение порядка**: Сохраняет исходный порядок слоев
- **Интеграция фильтров**: Сохраняет фильтры и выражения слоев

**Пример преобразования слоя**:
```json
// Исходный слой
{
  "id": "temperature-layer",
  "source": "source1",
  "type": "fill",
  "paint": { "fill-color": "#ff0000" }
}

// После объединения
{
  "id": "weather_temperature-layer", 
  "source": "weather_source1",
  "type": "fill",
  "paint": { "fill-color": "#ff0000" }
}
```

#### Объединение метаданных
Объединяет конфигурации фильтров и данные локализации:

**Обработка метаданных**:
- **Агрегация фильтров**: Объединяет конфигурации фильтров из всех источников
- **Объединение локализации**: Объединяет данные локализации для нескольких языков
- **Разрешение конфликтов**: Обрабатывает дублирующиеся имена фильтров и ключи локализации
- **Сохранение структуры**: Сохраняет целостность структуры метаданных

**Пример метаданных**:
```json
{
  "metadata": {
    "filters": {
      "weather": [
        { "id": "temperature", "name": "Temperature" },
        { "id": "precipitation", "name": "Precipitation" }
      ],
      "transport": [
        { "id": "roads", "name": "Roads" }
      ]
    },
    "locale": {
      "en": {
        "weather": "Weather",
        "temperature": "Temperature"
      },
      "ru": {
        "weather": "Погода", 
        "temperature": "Температура"
      }
    }
  }
}
```

### Структура выходных данных

Генерированный смешанный стиль включает комплексную спецификацию стиля Mapbox:

**Компоненты стиля**:
- **Версия**: Версия стиля Mapbox (8) для совместимости
- **Имя**: Имя смешанного стиля из конфигурации
- **Источники**: Объединенные источники тайлов с префиксными именами
- **Слои**: Объединенные определения слоев с обновленными ссылками
- **Метаданные**: Объединенные фильтры и данные локализации
- **Спрайт**: Ссылка на объединенные спрайт-активы
- **Глифы**: Конечная точка глифов шрифтов для рендеринга текста

**Полный пример стиля**:
```json
{
  "version": 8,
  "name": "Weather and Transport Style",
  "sources": {
    "weather_source1": {
      "type": "vector",
      "url": "https://example.com/weather-tiles"
    },
    "transport_source2": {
      "type": "vector", 
      "url": "https://example.com/transport-tiles"
    }
  },
  "layers": [
    {
      "id": "weather_temperature-layer",
      "source": "weather_source1",
      "type": "fill",
      "paint": { "fill-color": "#ff0000" }
    },
    {
      "id": "transport_roads-layer", 
      "source": "transport_source2",
      "type": "line",
      "paint": { "line-color": "#000000" }
    }
  ],
  "sprite": "/sprite/mix_style1_sprite",
  "glyphs": "/fonts/{fontstack}/{range}",
  "metadata": {
    "filters": {
      "weather": [
        { "id": "temperature", "name": "Temperature" }
      ],
      "transport": [
        { "id": "roads", "name": "Roads" }
      ]
    }
  }
}
```

### Интеграция

Бесшовно интегрируется с другими компонентами системы:

**Интеграция с StyleDownloader**:
- **Ввод файлов**: Читает необработанные файлы стилей, подготовленные StyleDownloader
- **Доступность ресурсов**: Обеспечивает доступность всех необходимых ресурсов
- **Обработка ошибок**: Обрабатывает отсутствующие файлы и поврежденные данные
- **Отслеживание прогресса**: Отчитывается о прогрессе смешивания и статусе

**Интеграция с SpriteMerger**:
- **Ссылки на спрайты**: Обновляет URL спрайтов для указания на объединенные активы
- **Выравнивание метаданных**: Обеспечивает соответствие метаданных спрайтов объединенным спрайтам
- **Поддержка разрешений**: Обрабатывает как обычные, так и @2x ссылки на спрайты
- **Генерация URL**: Создает правильные URL спрайтов для смешанных стилей

**Интеграция с конфигурацией**:
- **Обработка YAML**: Читает из `styles_config.yaml`
- **Определения стилей**: Обрабатывает конфигурации смешивания стилей
- **Управление источниками**: Обрабатывает несколько исходных стилей на смешивание
- **Организация выходных данных**: Сохраняет смешанные стили в директорию `mixed_styles/`

### Обработка ошибок

Комплексная обработка ошибок для различных сценариев смешивания:

**Ошибки файловой системы**:
- **Отсутствующие файлы**: Graceful обработка отсутствующих исходных файлов стилей
- **Поврежденные данные**: Валидация и восстановление из поврежденного JSON
- **Проблемы с правами**: Обрабатывает ошибки прав доступа и доступа к файлам
- **Дисковое пространство**: Проверяет доступное дисковое пространство перед записью

**Ошибки валидации данных**:
- **Неверный JSON**: Обрабатывает неправильно сформированный JSON в исходных стилях
- **Отсутствующие обязательные поля**: Валидирует обязательные поля стилей Mapbox
- **Несоответствие типов**: Обрабатывает неверные типы данных в определениях стилей
- **Ошибки ссылок**: Валидирует ссылки на источники и слои

**Разрешение конфликтов**:
- **Дублирующиеся имена**: Разрешает конфликты именования между исходными стилями
- **Коллизии префиксов**: Обеспечивает уникальную генерацию префиксов
- **Конфликты слоев**: Обрабатывает дублирующиеся ID и имена слоев
- **Конфликты источников**: Разрешает конфликты именования источников

**Graceful Degradation**:
- **Частичное смешивание**: Продолжает обработку, когда некоторые источники не удаются
- **Логирование ошибок**: Комплексное логирование для отладки
- **Резервные значения**: Использует значения по умолчанию, когда данные отсутствуют
- **Отчетность о прогрессе**: Отчитывается о прогрессе смешивания и статусе ошибок
